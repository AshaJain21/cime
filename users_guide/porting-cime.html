
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>6. Porting and validating CIME on a new platform &#8212; CIME 5.6 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="7. Timers and timing" href="timers.html" />
    <link rel="prev" title="5. Controlling processors and threads" href="pes-threads.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="timers.html" title="7. Timers and timing"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="pes-threads.html" title="5. Controlling processors and threads"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CIME 5.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Case Control System Part 1: Basic Usage</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="porting-and-validating-cime-on-a-new-platform">
<span id="porting"></span><h1>6. Porting and validating CIME on a new platform<a class="headerlink" href="#porting-and-validating-cime-on-a-new-platform" title="Permalink to this headline">¶</a></h1>
<p>One of the first steps for many users is getting CIME-based models running on their local machine.
This section describes that process.</p>
<div class="section" id="required-libraries-packages">
<h2>6.1. Required libraries/packages<a class="headerlink" href="#required-libraries-packages" title="Permalink to this headline">¶</a></h2>
<p>The machine needs to have:</p>
<ul class="simple">
<li>a functioning MPI environment (unless you plan to run on a single core with the CIME mpi-serial library).</li>
<li>build tools gmake and cmake,</li>
<li>a netcdf library version 4.3 or newer built with the same compiler you will use for CIME.</li>
</ul>
<p>A pnetcdf library is optional.</p>
<p>If you are using MPI, make sure you can run a basic MPI parallel program on your machine before you attempt a CIME port. You can use this <a class="reference internal" href="#mpi-example"><span class="std std-ref">MPI example</span></a> to check.</p>
</div>
<div class="section" id="an-mpi-example">
<span id="mpi-example"></span><h2>6.2. An MPI example<a class="headerlink" href="#an-mpi-example" title="Permalink to this headline">¶</a></h2>
<p>It is usually very helpful to assure that you can run a basic mpi parallel program on your machine prior to attempting a CIME port.
Understanding how to compile and run the program fhello_world_mpi.F90 shown here could potentially save many hours of frustration.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">program</span> <span class="n">fhello_world_mpi</span><span class="o">.</span><span class="n">F90</span>
  <span class="n">use</span> <span class="n">mpi</span>
  <span class="n">implicit</span> <span class="n">none</span>
  <span class="n">integer</span> <span class="p">(</span> <span class="n">kind</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">)</span> <span class="n">error</span>
  <span class="n">integer</span> <span class="p">(</span> <span class="n">kind</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">)</span> <span class="nb">id</span>
  <span class="n">integer</span> <span class="n">p</span>
  <span class="n">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">MPI_MAX_PROCESSOR_NAME</span><span class="p">)</span> <span class="p">::</span> <span class="n">name</span>
  <span class="n">integer</span> <span class="n">clen</span>
  <span class="n">integer</span><span class="p">,</span> <span class="n">allocatable</span> <span class="p">::</span> <span class="n">mype</span><span class="p">(:)</span>
  <span class="n">real</span> <span class="p">(</span> <span class="n">kind</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">)</span> <span class="n">wtime</span>

  <span class="n">call</span> <span class="n">MPI_Init</span> <span class="p">(</span> <span class="n">error</span> <span class="p">)</span>
  <span class="n">call</span> <span class="n">MPI_Comm_size</span> <span class="p">(</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">error</span> <span class="p">)</span>
  <span class="n">call</span> <span class="n">MPI_Comm_rank</span> <span class="p">(</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">error</span> <span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span> <span class="nb">id</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="n">then</span>
     <span class="n">wtime</span> <span class="o">=</span> <span class="n">MPI_Wtime</span> <span class="p">(</span> <span class="p">)</span>

     <span class="n">write</span> <span class="p">(</span> <span class="o">*</span><span class="p">,</span> <span class="s1">&#39;(a)&#39;</span> <span class="p">)</span> <span class="s1">&#39; &#39;</span>
     <span class="n">write</span> <span class="p">(</span> <span class="o">*</span><span class="p">,</span> <span class="s1">&#39;(a)&#39;</span> <span class="p">)</span> <span class="s1">&#39;HELLO_MPI - Master process:&#39;</span>
     <span class="n">write</span> <span class="p">(</span> <span class="o">*</span><span class="p">,</span> <span class="s1">&#39;(a)&#39;</span> <span class="p">)</span> <span class="s1">&#39;  FORTRAN90/MPI version&#39;</span>
     <span class="n">write</span> <span class="p">(</span> <span class="o">*</span><span class="p">,</span> <span class="s1">&#39;(a)&#39;</span> <span class="p">)</span> <span class="s1">&#39; &#39;</span>
     <span class="n">write</span> <span class="p">(</span> <span class="o">*</span><span class="p">,</span> <span class="s1">&#39;(a)&#39;</span> <span class="p">)</span> <span class="s1">&#39;  An MPI test program.&#39;</span>
     <span class="n">write</span> <span class="p">(</span> <span class="o">*</span><span class="p">,</span> <span class="s1">&#39;(a)&#39;</span> <span class="p">)</span> <span class="s1">&#39; &#39;</span>
     <span class="n">write</span> <span class="p">(</span> <span class="o">*</span><span class="p">,</span> <span class="s1">&#39;(a,i8)&#39;</span> <span class="p">)</span> <span class="s1">&#39;  The number of processes is &#39;</span><span class="p">,</span> <span class="n">p</span>
     <span class="n">write</span> <span class="p">(</span> <span class="o">*</span><span class="p">,</span> <span class="s1">&#39;(a)&#39;</span> <span class="p">)</span> <span class="s1">&#39; &#39;</span>
  <span class="n">end</span> <span class="k">if</span>
  <span class="n">call</span> <span class="n">MPI_GET_PROCESSOR_NAME</span><span class="p">(</span><span class="n">NAME</span><span class="p">,</span> <span class="n">CLEN</span><span class="p">,</span> <span class="n">ERROR</span><span class="p">)</span>
  <span class="n">write</span> <span class="p">(</span> <span class="o">*</span><span class="p">,</span> <span class="s1">&#39;(a)&#39;</span> <span class="p">)</span> <span class="s1">&#39; &#39;</span>
  <span class="n">write</span> <span class="p">(</span> <span class="o">*</span><span class="p">,</span> <span class="s1">&#39;(a,i8,a,a)&#39;</span> <span class="p">)</span> <span class="s1">&#39;  Process &#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="s1">&#39; says &quot;Hello, world!&quot; &#39;</span><span class="p">,</span><span class="n">name</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">clen</span><span class="p">)</span>

  <span class="n">call</span> <span class="n">MPI_Finalize</span> <span class="p">(</span> <span class="n">error</span> <span class="p">)</span>
<span class="n">end</span> <span class="n">program</span>
</pre></div>
</div>
<p>As an example, on a MAC with 2 cores that has mpich with gnu fortran you would issue the following two commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">mpif90</span> <span class="n">fhello_world_mpi</span><span class="o">.</span><span class="n">F90</span> <span class="o">-</span><span class="n">o</span> <span class="n">hello_world</span>
<span class="o">&gt;</span> <span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="mi">2</span> <span class="o">./</span><span class="n">hello_world</span>
</pre></div>
</div>
</div>
<div class="section" id="cesm-linux-and-mac-support">
<h2>6.3. CESM Linux and Mac Support<a class="headerlink" href="#cesm-linux-and-mac-support" title="Permalink to this headline">¶</a></h2>
<p>The distribution of CESM includes machines called <strong>homebrew</strong> and <strong>centos7-linux</strong> in the file <strong>$CIMEROOT/config/cesm/machines/config_machines.xml</strong>.
Please see the instructions in the file to create the directory structure and use these generic machine definitions.</p>
</div>
<div class="section" id="steps-for-porting">
<h2>6.4. Steps for porting<a class="headerlink" href="#steps-for-porting" title="Permalink to this headline">¶</a></h2>
<p>Porting CIME involves several steps. The first step is to define your machine. You can do this in one of two ways:</p>
<ol class="arabic">
<li><p class="first">You can edit <strong>$CIMEROOT/config/$model/machines/config_machines.xml</strong> and add an appropriate section for your machine.</p>
</li>
<li><p class="first">You can use your <strong>$HOME/.cime</strong> directory (see <a class="reference internal" href="cime-config.html#customizing-cime"><span class="std std-ref">CIME user config directory</span></a>).
In particular, you can create a <strong>$HOME/.cime/config_machines.xml</strong> file with the definition for your machine.
A template to create this definition is provided in <strong>$CIMEROOT/config/xml_schemas/config_machines_template.xml</strong>. More details are provided in the template file.
In addition, if you have a batch system, you will also need to add a <strong>config_batch.xml</strong> file to your <strong>$HOME/.cime</strong> directory.
All files in <strong>$HOME/.cime/</strong> are appended to the xml objects that are read into memory from the <strong>$CIME/config/$model</strong>, where <strong>$model</strong> is either <code class="docutils literal notranslate"><span class="pre">e3sm</span></code> or <code class="docutils literal notranslate"><span class="pre">cesm</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you use method (2), you can download CIME updates without affecting your machine definitions in <strong>$HOME/.cime</strong>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you will be supporting many users on your new machine, then we recommend using method (1) and issuing a GitHub pull request with your machine updates.</p>
</div>
</li>
</ol>
<p>In what follows we outline the process for method (2) above:</p>
<ul>
<li><p class="first">Create a <strong>$HOME/.cime</strong> directory and create a <strong>config_machines.xml</strong> file in that directory.</p>
<p>This file contains all the information you must set in order to configure a new machine to be CIME-compliant.</p>
<p>Fill in the contents of <strong>$HOME/.cime/config_machines.xml</strong> that are specific to your machine. For more details see <a class="reference internal" href="machine.html#machinefile"><span class="std std-ref">the config_machines.xml file</span></a>.</p>
<p>Check to ensure that your <strong>config_machines.xml</strong> file conforms to the CIME schema definition by doing the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>xmllint --noout --schema $CIME/config/xml_schemas/config_machines.xsd $HOME/.cime/config_machines.xml
</pre></div>
</div>
</li>
<li><p class="first">If you find that you need to introduce compiler settings specific to your machine, create a <strong>$HOME/.cime/config_compilers.xml</strong> file.
The default compiler settings are defined in <strong>$CIME/config/$model/machines/config_compilers.xml</strong>. There is no template for <strong>config_compilers.xml</strong>.</p>
</li>
<li><p class="first">If you have a batch system, you may also need to create a <strong>$HOME/.cime/config_batch.xml</strong> file.
Out-of-the-box batch settings are set in <strong>$CIME/config/$model/machines/config_batch.xml</strong>.</p>
</li>
<li><p class="first">Once you have defined a basic configuration for your machine in your <strong>$HOME/.cime</strong> xml files, run <strong>scripts_regression_test.py</strong> interactively. This test is found and must be run in the directory <strong>$CIMEROOT/scripts/tests/</strong>.
This performs a number of basic unit tests starting from the simplest and working toward more complicated ones. If you have problems running <strong>scripts_regression_tests.py</strong>, see <span class="xref std std-ref">scripts_regression_tests</span>.</p>
</li>
</ul>
<p>After running those steps correctly, you are ready to try a case at your target compset and resolution.</p>
</div>
<div class="section" id="validating-a-cesm-port-with-prognostic-components">
<h2>6.5. Validating a CESM port with prognostic components<a class="headerlink" href="#validating-a-cesm-port-with-prognostic-components" title="Permalink to this headline">¶</a></h2>
<p>The following port validation is recommended for any new machine.
Carrying out these steps does not guarantee the model is running
properly in all cases nor that the model is scientifically valid on
the new machine.</p>
<p>In addition to these tests, detailed validation should be carried out
for any new production run.  That means verifying that model restarts
are bit-for-bit identical with a baseline run, that the model is
bit-for-bit reproducible when identical cases are run for several
months, and that production cases are monitored carefully as they
integrate forward to identify any potential problems as early as
possible.</p>
<p>Users are responsible for their own validation process,
especially with respect to science validation.</p>
<p>These are the recommended steps for validating a port for the CESM model:</p>
<ol class="arabic">
<li><p class="first">Verify basic functionality of your port by performing the cheyenne “prealpha” tests on your machine. This can be done by issuing the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">create_test</span> <span class="o">--</span><span class="n">xml</span><span class="o">-</span><span class="n">category</span> <span class="n">prealpha</span> <span class="o">--</span><span class="n">xml</span><span class="o">-</span><span class="n">machine</span> <span class="n">cheyenne</span> <span class="o">--</span><span class="n">xml</span><span class="o">-</span><span class="n">compiler</span> <span class="n">intel</span> <span class="o">--</span><span class="n">machine</span> <span class="o">&lt;</span><span class="n">your_machine_name</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">compiler</span> <span class="o">&lt;</span><span class="n">your_compiler_name</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>This command will run the prealpha tests <em>defined</em> for cheyenne with the intel compiler, but will run them on <em>your</em> machine with <em>your</em> compiler.
These tests will be run in the <strong>$CIME_OUTPUT_ROOT</strong>. To see the results of tests, you need to do the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&gt; $CIME_OUTPUT_ROOT/cs.status.[testid]
</pre></div>
</div>
<p>where testid was indicated in the output when calling <a class="reference external" href="../Tools_user/create_test.html">create_test</a></p>
</li>
<li><p class="first">Carry out ensemble consistency tests:</p>
<p>This is described in <strong>$CIMEROOT/tools/statistical_ensemble_test/README</strong>.
The CESM-ECT (CESM Ensemble Consistency Test) determines whether a new simulation set up (new machine, compiler, etc.) is statistically distinguishable from an accepted ensemble.
The ECT process involves comparing several runs (3) generated with the new scenario to an ensemble built on a trusted machine (currently cheyenne).
The python ECT tools are located in the pyCECT subdirectory <a href="#id1"><span class="problematic" id="id2">**</span></a>$CIMEROOT/tools/statistical_ensemble_test/pyCECT.</p>
<p>The verification tools in the CESM-ECT suite are:</p>
<p><code class="docutils literal notranslate"><span class="pre">CAM-ECT</span></code>: detects issues in CAM and CLM (12 month runs)</p>
<p><code class="docutils literal notranslate"><span class="pre">UF-CAM-ECT</span></code>: detects issues in CAM and CLM (9 time step runs)</p>
<p><code class="docutils literal notranslate"><span class="pre">POP-ECT</span></code>: detects issues in POP and CICE (12 month runs)</p>
<p>Follow the instructions in the <strong>README</strong> file to generate three ensemble runs for any of the above tests that are most relevant to your port.
Then please go to the <a class="reference external" href="http://www.cesm.ucar.edu/models/cesm2.0/verification">CESM2 ensemble verification website</a>, where you can upload your files and subsequently obtain a quick response as to the success or failure of your verification.</p>
</li>
</ol>
</div>
<div class="section" id="performance-tuning-of-a-cesm-port">
<h2>6.6. Performance tuning of a CESM port<a class="headerlink" href="#performance-tuning-of-a-cesm-port" title="Permalink to this headline">¶</a></h2>
<p>Once you have performed the verification that your port is successful,
you will want to determine the optimal pe-layout for your target
configurations (i.e. compset/resolution combinations).  See the file
<strong>$CIMEROOT/tools/load_balancing_tools/README</strong> to understand how to
utilize the load balancing utilty. This utility finds reasonable PE
layouts for CIME-driven models. It will find these from timing files
you provide or from runs done by the tool.</p>
<p>Once you are happy with the PE-layout for your target configuration,
you can it to the relevant <strong>config_pes.xml</strong> file for the component
that is responsible for generating the PE-layout for the target
configuration (this is normally referred to as the “primary”
component).</p>
<p>Timing summaries for every successful case run, are located in the
case subdirectory <strong>$CASEROOT/timing</strong>. In addition, every
<strong>cpl.log.timestamp</strong> output file contains diagnostic timing
information. Search for <code class="docutils literal notranslate"><span class="pre">tStamp</span></code> in this file to see this
information. The timing information is useful for tracking down
temporal variability in model cost due to either inherent model
variability cost (I/O, spin-up, seasonal, and so on) or hardware.  The
model daily cost generally is pretty constant unless I/O is written
intermittently, such as at the end of the month.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">6. Porting and validating CIME on a new platform</a><ul>
<li><a class="reference internal" href="#required-libraries-packages">6.1. Required libraries/packages</a></li>
<li><a class="reference internal" href="#an-mpi-example">6.2. An MPI example</a></li>
<li><a class="reference internal" href="#cesm-linux-and-mac-support">6.3. CESM Linux and Mac Support</a></li>
<li><a class="reference internal" href="#steps-for-porting">6.4. Steps for porting</a></li>
<li><a class="reference internal" href="#validating-a-cesm-port-with-prognostic-components">6.5. Validating a CESM port with prognostic components</a></li>
<li><a class="reference internal" href="#performance-tuning-of-a-cesm-port">6.6. Performance tuning of a CESM port</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="pes-threads.html"
                        title="previous chapter">5. Controlling processors and threads</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="timers.html"
                        title="next chapter">7. Timers and timing</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/users_guide/porting-cime.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="timers.html" title="7. Timers and timing"
             >next</a> |</li>
        <li class="right" >
          <a href="pes-threads.html" title="5. Controlling processors and threads"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CIME 5.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Case Control System Part 1: Basic Usage</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, U.S. National Science Foundation and U.S. Department of Energy.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.
    </div>
  </body>
</html>