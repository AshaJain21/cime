
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>10. Multi-instance component functionality &#8212; CIME 5.6 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="11. Workflows" href="workflows.html" />
    <link rel="prev" title="9. Fortran Unit Testing" href="unit_testing.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="workflows.html" title="11. Workflows"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="unit_testing.html" title="9. Fortran Unit Testing"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CIME 5.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Case Control System Part 1: Basic Usage</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="multi-instance-component-functionality">
<span id="multi-instance"></span><h1>10. Multi-instance component functionality<a class="headerlink" href="#multi-instance-component-functionality" title="Permalink to this headline">¶</a></h1>
<p>The CIME coupling infrastructure is capable of running multiple
component instances (ensembles) under one model executable.  There are
two modes of ensemble capability, single driver in which all component
instances are handled by a single driver/coupler component or
multi-driver in which each instance includes a separate driver/coupler
component.  In the multi-driver mode the entire model is duplicated
for each instance while in the single driver mode only active
components need be duplicated.  In most cases the multi-driver mode
will give better performance and should be used.</p>
<p>The primary motivation for this development was to be able to run an
ensemble Kalman-Filter for data assimilation and parameter estimation
(UQ, for example).  However, it also provides the ability to run a set
of experiments within a single model executable where each instance
can have a different namelist, and to have all the output go to one
directory.</p>
<p>An F compset is used in the following example. Using the
multiple-instance code involves the following steps:</p>
<p>1. Create the case.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">create_newcase</span> <span class="o">--</span><span class="n">case</span> <span class="n">Fmulti</span> <span class="o">--</span><span class="n">compset</span> <span class="n">F2000_DEV</span> <span class="o">--</span><span class="n">res</span> <span class="n">f19_f19_mg17</span>
<span class="o">&gt;</span> <span class="n">cd</span> <span class="n">Fmulti</span>
</pre></div>
</div>
<p>2. Assume this is the out-of-the-box pe-layout:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Comp</span>  <span class="n">NTASKS</span>  <span class="n">NTHRDS</span>  <span class="n">ROOTPE</span>
<span class="n">CPL</span> <span class="p">:</span>    <span class="mi">144</span><span class="o">/</span>     <span class="mi">1</span><span class="p">;</span>      <span class="mi">0</span>
<span class="n">ATM</span> <span class="p">:</span>    <span class="mi">144</span><span class="o">/</span>     <span class="mi">1</span><span class="p">;</span>      <span class="mi">0</span>
<span class="n">LND</span> <span class="p">:</span>    <span class="mi">144</span><span class="o">/</span>     <span class="mi">1</span><span class="p">;</span>      <span class="mi">0</span>
<span class="n">ICE</span> <span class="p">:</span>    <span class="mi">144</span><span class="o">/</span>     <span class="mi">1</span><span class="p">;</span>      <span class="mi">0</span>
<span class="n">OCN</span> <span class="p">:</span>    <span class="mi">144</span><span class="o">/</span>     <span class="mi">1</span><span class="p">;</span>      <span class="mi">0</span>
<span class="n">ROF</span> <span class="p">:</span>    <span class="mi">144</span><span class="o">/</span>     <span class="mi">1</span><span class="p">;</span>      <span class="mi">0</span>
<span class="n">GLC</span> <span class="p">:</span>    <span class="mi">144</span><span class="o">/</span>     <span class="mi">1</span><span class="p">;</span>      <span class="mi">0</span>
<span class="n">WAV</span> <span class="p">:</span>    <span class="mi">144</span><span class="o">/</span>     <span class="mi">1</span><span class="p">;</span>      <span class="mi">0</span>
<span class="n">ESP</span> <span class="p">:</span>      <span class="mi">1</span><span class="o">/</span>     <span class="mi">1</span><span class="p">;</span>      <span class="mi">0</span>
</pre></div>
</div>
<p>The atm, lnd, rof and glc are active components in this compset. The ocn is
a prescribed data component, cice is a mixed prescribed/active
component (ice-coverage is prescribed), and wav and esp are stub
components.</p>
<p>Let’s say we want to run two instances of CAM in this experiment.  We
will also have to run two instances of CLM, CICE, RTM and GLC.  However, we
can run either one or two instances of DOCN, and we can ignore the
stub components since they do not do anything in this compset.</p>
<p>To run two instances of CAM, CLM, CICE, RTM, GLC and DOCN, invoke the following :ref: <cite>xmlchange&lt;modifying-an-xml-file&gt;</cite> commands in your <strong>$CASEROOT</strong> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="o">./</span><span class="n">xmlchange</span> <span class="n">NINST_ATM</span><span class="o">=</span><span class="mi">2</span>
<span class="o">&gt;</span> <span class="o">./</span><span class="n">xmlchange</span> <span class="n">NINST_LND</span><span class="o">=</span><span class="mi">2</span>
<span class="o">&gt;</span> <span class="o">./</span><span class="n">xmlchange</span> <span class="n">NINST_ICE</span><span class="o">=</span><span class="mi">2</span>
<span class="o">&gt;</span> <span class="o">./</span><span class="n">xmlchange</span> <span class="n">NINST_ROF</span><span class="o">=</span><span class="mi">2</span>
<span class="o">&gt;</span> <span class="o">./</span><span class="n">xmlchange</span> <span class="n">NINST_GLC</span><span class="o">=</span><span class="mi">2</span>
<span class="o">&gt;</span> <span class="o">./</span><span class="n">xmlchange</span> <span class="n">NINST_OCN</span><span class="o">=</span><span class="mi">2</span>
</pre></div>
</div>
<p>As a result, you will have two instances of CAM, CLM and CICE (prescribed), RTM, GLC, and DOCN, each running concurrently on 72 MPI tasks and all using the same driver/coupler component.   In this single driver/coupler mode the number of tasks for each component instance is NTASKS_COMPONENT/NINST_COMPONENT and the total number of tasks is the same as for the single instance case.</p>
<p>Now consider the multi driver model.
To use this mode change</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="o">./</span><span class="n">xmlchange</span> <span class="n">MULTI_DRIVER</span><span class="o">=</span><span class="n">TRUE</span>
</pre></div>
</div>
<p>This configuration will run each component instance on the original 144 tasks but will generate two copies of the model (in the same executable) for a total of 288 tasks.</p>
<p>3. Set up the case</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="o">./</span><span class="n">case</span><span class="o">.</span><span class="n">setup</span>
</pre></div>
</div>
<p>A new <strong>user_nl_xxx_NNNN</strong> file is generated for each component instance when case.setup is called (where xxx is the component type and NNNN is the number of the component instance).
When calling <strong>case.setup</strong> with the <strong>env_mach_pes.xml</strong> file specifically, these files are created in <strong>$CASEROOT</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">user_nl_cam_0001</span> <span class="n">user_nl_clm_0001</span> <span class="n">user_nl_docn_0001</span> <span class="n">user_nl_cice_0001</span>
<span class="n">user_nl_cism_0001</span> <span class="n">user_nl_mosart_0001</span>
<span class="n">user_nl_cam_0002</span> <span class="n">user_nl_clm_0002</span> <span class="n">user_nl_docn_0002</span> <span class="n">user_nl_cice_0002</span>
<span class="n">user_nl_cism_0002</span> <span class="n">user_nl_mosart_0002</span>
<span class="n">user_nl_cpl</span>
</pre></div>
</div>
<p>The namelist for each component instance can be modified by changing the corresponding <strong>user_nl_xxx_NNNN</strong> file.
Modifying <strong>user_nl_cam_0002</strong> will result in your namelist changes being active ONLY for the second instance of CAM.
To change the DOCN stream txt file instance 0002, copy <strong>docn.streams.txt.prescribed_0002</strong> to your <strong>$CASEROOT</strong> directory with the name <strong>user_docn.streams.txt.prescribed_0002</strong> and modify it accordlingly.</p>
<p>Also keep these important points in mind:</p>
<ol class="arabic simple">
<li>Note that these changes can be made at create_newcase time with option –ninst # where # is a positive integer, use the additional logical option –multi-driver to invoke the multi-driver mode.</li>
<li><strong>Multiple component instances can differ ONLY in namelist settings; they ALL use the same model executable.</strong></li>
<li>Calling <strong>case.setup</strong> with <code class="docutils literal notranslate"><span class="pre">--clean</span></code> <em>DOES NOT</em> remove the <strong>user_nl_xxx_NN</strong> (where xxx is the component name) files created by <strong>case.setup</strong>.</li>
<li>A special variable NINST_LAYOUT is provided for some experimental compsets, its value should be
‘concurrent’ for all but a few special cases and it cannot be used if MULTI_DRIVER=TRUE.</li>
<li>In <strong>create_test</strong> these options can be invoked with testname modifiers _N# for the single driver mode and _C# for the multi-driver mode.  These are mutually exclusive options, they cannot be combined.</li>
<li>In create_newcase you may use –ninst # to set the number of instances and –multi-driver for multi-driver mode.</li>
<li>In multi-driver mode you will always get 1 instance of each component for each driver/coupler, if you change a case using xmlchange MULTI_COUPLER=TRUE you will get a number of driver/couplers equal to the maximum NINST value over all components.</li>
</ol>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="unit_testing.html"
                        title="previous chapter">9. Fortran Unit Testing</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="workflows.html"
                        title="next chapter">11. Workflows</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/users_guide/multi-instance.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="workflows.html" title="11. Workflows"
             >next</a> |</li>
        <li class="right" >
          <a href="unit_testing.html" title="9. Fortran Unit Testing"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CIME 5.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Case Control System Part 1: Basic Usage</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, U.S. National Science Foundation and U.S. Department of Energy.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.3.
    </div>
  </body>
</html>